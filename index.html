<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Reader Pro</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-container {
            display: flex;
            flex-grow: 1;
            min-width: 300px;
        }
        #search-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        #search-button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 16px;
        }
        #search-button:hover {
            background-color: #2980b9;
        }
        .source-selector {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 200px;
        }
        .manga-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .manga-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .manga-card:hover {
            transform: translateY(-5px);
        }
        .manga-cover {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background-color: #eee;
        }
        .manga-info {
            padding: 15px;
        }
        .manga-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .manga-details {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Manga Reader Pro</h1>
    
    <div class="controls">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search for manga...">
            <button id="search-button">Search</button>
        </div>
        <select id="source-selector" class="source-selector">
            <option value="mangadex">MangaDex</option>
            <!-- Extensions will be loaded here -->
        </select>
    </div>
    
    <div id="results-container">
        <div class="loading">Loading popular manga...</div>
    </div>

    <div class="pagination" id="pagination">
        <button id="prev-page" disabled>Previous</button>
        <span id="page-info">Page 1</span>
        <button id="next-page">Next</button>
    </div>

    <script>
        // Global variables
        let extensions = {};
        let currentSource = 'mangadex';
        let currentPage = 1;
        let totalPages = 1;
        let currentQuery = '';

        // DOM Elements
        const resultsContainer = document.getElementById('results-container');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            await loadExtensions();
            setupEventListeners();
            fetchManga();
        });

        // Load extensions from GitHub
        async function loadExtensions() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json');
                extensions = await response.json();
                
                const selector = document.getElementById('source-selector');
                Object.keys(extensions).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = extensions[key].name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load extensions:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('search-button').addEventListener('click', () => {
                currentQuery = document.getElementById('search-input').value.trim();
                currentPage = 1;
                fetchManga();
            });
            
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentQuery = document.getElementById('search-input').value.trim();
                    currentPage = 1;
                    fetchManga();
                }
            });
            
            document.getElementById('source-selector').addEventListener('change', (e) => {
                currentSource = e.target.value;
                currentPage = 1;
                fetchManga();
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchManga();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchManga();
                }
            });
        }

        // Main function to fetch manga
        async function fetchManga() {
            resultsContainer.innerHTML = '<div class="loading">Loading...</div>';
            updatePagination();
            
            try {
                let data;
                if (currentSource === 'mangadex') {
                    data = await fetchMangaDex();
                } else {
                    data = await fetchExtensionSource();
                }
                
                if (data.data && data.data.length > 0) {
                    displayManga(data.data);
                    totalPages = Math.ceil(data.total / 20) || 1;
                } else {
                    resultsContainer.innerHTML = '<div class="error">No manga found</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                resultsContainer.innerHTML = `<div class="error">Error loading manga: ${error.message}</div>`;
            }
            
            updatePagination();
        }

        // Fetch from MangaDex
        async function fetchMangaDex() {
            let url = '/api/manga';
            const params = new URLSearchParams();
            
            params.append('includes[]', 'cover_art');
            params.append('contentRating[]', 'safe');
            params.append('contentRating[]', 'suggestive');
            params.append('limit', '20');
            params.append('offset', String((currentPage - 1) * 20));
            
            if (currentQuery) {
                params.append('title', currentQuery);
                params.append('order[relevance]', 'desc');
            } else {
                params.append('order[followedCount]', 'desc');
            }
            
            const response = await fetch(`${url}?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to fetch manga');
            
            const data = await response.json();
            return {
                data: data.data,
                total: data.total || data.data.length
            };
        }

        // Fetch from extension source
        async function fetchExtensionSource() {
            const ext = extensions[currentSource];
            if (!ext) throw new Error('Extension not found');
            
            try {
                // This is a simplified implementation - in a real app you'd need to handle
                // the extension's specific API requirements
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(ext.baseUrl)}&source=${currentSource}&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`);
                if (!response.ok) throw new Error('Failed to fetch from extension');
                
                return await response.json();
            } catch (error) {
                console.error('Extension fetch error:', error);
                throw new Error(`Failed to load from ${ext.name}`);
            }
        }

        // Display manga results
        function displayManga(mangaList) {
            let html = '<div class="manga-grid">';
            
            mangaList.forEach(manga => {
                const title = manga.attributes?.title?.en || 
                             manga.attributes?.title?.ja || 
                             manga.attributes?.title?.['ja-ro'] || 
                             manga.title ||
                             Object.values(manga.attributes?.title || {})[0] || 
                             'Untitled';
                
                // Handle different cover image formats
                let coverUrl = '';
                if (manga.relationships) {
                    const coverArt = manga.relationships.find(r => r.type === 'cover_art');
                    if (coverArt?.attributes?.fileName) {
                        coverUrl = `https://uploads.mangadex.org/covers/${manga.id}/${coverArt.attributes.fileName}.256.jpg`;
                    }
                } else if (manga.cover) {
                    coverUrl = manga.cover.startsWith('http') ? manga.cover : `${extensions[currentSource]?.baseUrl || ''}${manga.cover}`;
                }
                
                html += `
                    <div class="manga-card">
                        <img src="${coverUrl || 'https://via.placeholder.com/200x300?text=No+Cover'}" 
                             alt="${title}" 
                             class="manga-cover"
                             onerror="this.src='https://via.placeholder.com/200x300?text=No+Cover'">
                        <div class="manga-info">
                            <div class="manga-title">${title}</div>
                            <div class="manga-details">
                                <span>${manga.attributes?.status || manga.status || 'N/A'}</span>
                                <span>${manga.attributes?.year || manga.year || ''}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        }

        // Update pagination controls
        function updatePagination() {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }
    </script>
</body>
</html>
